<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Davomat Nazorati v2.2</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --dark-card: rgba(15, 23, 42, 0.9);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: #0f172a url('/assets/logo.png') no-repeat fixed center !important;
            background-size: 30% !important;
            /* Slightly smaller logo for more premium feel */
            min-height: 100vh;
            margin: 0;
            padding: 140px 0 0 0 !important;
            /* Improved space for widgets + navbar */
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.3);
            /* Even lighter to show logo clearly */
            z-index: -1;
        }

        .dashboard-container {
            width: 98%;
            max-width: 1750px;
            margin: 20px auto;
            padding: 10px;
            position: relative;
            z-index: 10;
        }

        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 35px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 18px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-btn {
            padding: 12px 28px;
            border: none;
            background: transparent;
            border-radius: 14px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            color: #94a3b8;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .report-view {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .report-view.active {
            display: block;
            animation: slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 25px;
            font-size: 0.9rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.15);
        }

        .leaderboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .l-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            margin-bottom: 8px;
            border-left: 4px solid transparent;
        }

        .l-item.top {
            border-left-color: #10b981;
        }

        .l-item.bottom {
            border-left-color: #f43f5e;
        }

        .ai-insight {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.2);
            padding: 20px;
            border-radius: 18px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .ai-insight i {
            color: #818cf8;
            font-size: 1.5rem;
            margin-top: 5px;
        }

        .ai-text {
            line-height: 1.5;
            color: #cbd5e1;
            font-size: 0.95rem;
        }

        th {
            background: #1e293b !important;
            color: white !important;
            padding: 14px 8px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        table td {
            color: rgba(255, 255, 255, 0.9) !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
        }

        table td {
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        input[type="date"],
        select {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            border-radius: 20px;
            padding: 18px 30px;
            font-family: 'Outfit', sans-serif;
            outline: none;
            font-size: 1.2rem;
            min-width: 300px;
            cursor: pointer;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
        }

        select:focus,
        input[type="date"]:focus {
            border-color: var(--accent);
            box-shadow: 0 0 30px var(--accent-glow);
            background: rgba(255, 255, 255, 0.15) !important;
            transform: scale(1.02);
        }

        select option {
            background: #0f172a !important;
            color: white !important;
            padding: 15px;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.4) !important;
        }

        .report-view {
            width: 100%;
            overflow-x: auto;
        }

        #tumanTable th {
            font-size: 11px;
            padding: 12px 6px;
        }

        #tumanTable td {
            font-size: 14px;
            padding: 12px 6px;
        }

        .fa-check-circle {
            text-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
            color: #10b981;
        }

        .fa-times-circle {
            text-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
            color: #f43f5e;
        }

        .export-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 35px;
            border-radius: 20px;
            border: none;
            font-weight: 700;
            transition: 0.3s;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(16, 185, 129, 0.4);
        }

        .logout-btn {
            background: #f43f5e;
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            margin-bottom: 20px;
            float: right;
        }

        .logout-btn:hover {
            background: #e11d48;
            transform: scale(1.05);
        }

        th:first-child {
            border-radius: 10px 0 0 0;
        }

        th:last-child {
            border-radius: 0 10px 0 0;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
        }

        tr:last-child td:first-child {
            border-bottom-left-radius: 10px;
        }

        tr:last-child td:last-child {
            border-bottom-right-radius: 10px;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.05) !important;
            color: #fff !important;
        }

        tr {
            transition: all 0.3s ease;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 30px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-high {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-low {
            background: rgba(244, 63, 94, 0.2);
            color: #f43f5e;
            border: 1px solid rgba(244, 63, 94, 0.3);
        }

        .controls {
            display: flex;
            gap: 30px;
            align-items: flex-end;
            background: rgba(255, 255, 255, 0.03);
            padding: 30px;
            border-radius: 25px;
            margin-bottom: 40px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-left: 5px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .stat-card h4 {
            margin: 0;
            color: #cbd5e1;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="top-widgets-bar">
        <div class="widget-item weather" id="weatherWidget"><i class="fas fa-cloud-sun"></i> <span>...</span></div>
        <div class="widget-item clock"><i class="fas fa-clock"></i> <span id="liveClock">00:00:00</span></div>
        <div class="widget-item countdown"><i class="fas fa-hourglass-half"></i> <span
                id="submissionTimer">00:00:00</span></div>

        <div class="nav-controls" style="margin-left:auto; display:flex; align-items:center; gap:15px;">
            <div id="userProfileDisplay"></div>
            <button onclick="toggleTheme()" class="theme-toggle-btn icon-btn" title="Mavzu"><i
                    class="fas fa-moon"></i></button>
            <div class="lang-switcher">
                <button onclick="changeLang('uz')" class="lang-btn" id="uz_btn">UZ</button>
                <button onclick="changeLang('ru')" class="lang-btn" id="ru_btn">RU</button>
            </div>
        </div>
    </div>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-left">
                <img src="logo.png" alt="Logo" class="nav-logo">
                <div class="nav-branding">
                    <h3>Farg‚Äòona viloyati VMMTB</h3>
                    <p style="margin:0; font-weight:bold; color:var(--primary)" id="nav_user_fish"></p>
                    <p data-i18n="nav_dashboard">Davomat Nazorati (Dashboard)</p>
                </div>
            </div>
            <div class="nav-right">
                <a href="/" class="nav-link" data-i18n="nav_home">Asosiy sahifa</a>
                <a href="/davomat.html" class="nav-link" data-i18n="nav_form">Davomat kiritish</a>
                <a href="/dashboard.html" class="nav-link active" data-i18n="nav_dashboard">Dashboard</a>
                <a href="/about.html" class="nav-link" data-i18n="nav_about">Biz haqimizda</a>
                <a href="javascript:logout()" class="nav-link" data-i18n="nav_logout"><i
                        class="fas fa-sign-out-alt"></i> Chiqish</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('viloyat')" id="tab_viloyat" data-i18n="tab_v_svod">
                <i class="fas fa-map"></i> Viloyat Svod
            </button>
            <button class="tab-btn" onclick="showTab('tuman')" id="tab_tuman" data-i18n="tab_t_svod">
                <i class="fas fa-school"></i> Tuman Svod
            </button>
            <button class="tab-btn" onclick="showTab('students')" id="tab_students" data-i18n="tab_absents">
                <i class="fas fa-users"></i> Sababsizlar
            </button>
            <button class="tab-btn" onclick="showTab('recent')" id="tab_recent" data-i18n="tab_monitor">
                <i class="fas fa-bolt"></i> Jonli Monitor
            </button>
            <button class="tab-btn" onclick="showTab('analysis')" id="tab_analysis" data-i18n="tab_analysis">
                <i class="fas fa-chart-line"></i> Tahlil
            </button>
            <button class="tab-btn" onclick="showTab('profile')" id="tab_profile" data-i18n="tab_profile">
                <i class="fas fa-user-cog"></i> Profil
            </button>
            <button class="tab-btn" onclick="showTab('school')" id="tab_school" style="display:none"
                data-i18n="tab_school">
                <i class="fas fa-school"></i> Mening Maktabim
            </button>
            <button class="tab-btn" onclick="showTab('admin')" id="tab_admin" style="display:none"
                data-i18n="tab_admin">
                <i class="fas fa-users-cog"></i> Admin Panel
            </button>
        </div>

        <!-- 1. VILOYAT SVODI -->
        <div id="viloyatView" class="report-view active">
            <div class="controls">
                <div class="filter-group">
                    <label>Sana</label>
                    <input type="date" id="viloyatDate" onchange="loadViloyatData()">
                </div>
                <button class="export-btn" onclick="exportViloyatExcel()">
                    <i class="fas fa-file-excel"></i> Excelga saqlash
                </button>
            </div>

            <div class="stat-card" style="margin-bottom: 20px;">
                <h4><i class="fas fa-map-marked-alt"></i> <span data-i18n="tab_v_svod">Viloyat Svod</span></h4>
                <div id="mapContainer" class="map-grid"></div>
                <div class="map-legend">
                    <span class="legend-item"><i class="fas fa-square" style="color:#10b981"></i> 95%+</span>
                    <span class="legend-item"><i class="fas fa-square" style="color:#facc15"></i> 90-95%</span>
                    <span class="legend-item"><i class="fas fa-square" style="color:#f43f5e"></i> &lt;90%</span>
                </div>
            </div>

            <div class="summary-grid">
                <div class="stat-card">
                    <h4 data-i18n="stat_entries">Jami kiritilgan</h4>
                    <div class="value" id="v_total_entries">0</div>
                </div>
                <div class="stat-card">
                    <h4 data-i18n="stat_avg">O'rtacha davomat</h4>
                    <div class="value" id="v_avg_percent">0.0%</div>
                </div>
                <div class="stat-card">
                    <h4 data-i18n="stat_absents">Sababsizlar</h4>
                    <div class="value red" id="v_total_sababsiz">0</div>
                </div>
                <div class="stat-card">
                    <h4 data-i18n="stat_total_students">Jami o'quvchi</h4>
                    <div class="value" id="v_total_students">0</div>
                </div>
            </div>

            <div class="table-container">
                <table id="viloyatTable">
                    <thead>
                        <tr>
                            <th data-i18n="col_district">Hudud nomi</th>
                            <th data-i18n="col_schools">Maktablar</th>
                            <th data-i18n="col_student">O'quvchi</th>
                            <th data-i18n="col_sababli">Sababli</th>
                            <th data-i18n="col_sababsiz">Sababsiz</th>
                            <th data-i18n="col_yesterday">Kecha (%)</th>
                            <th data-i18n="col_today">Bugun (%)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <!-- 2. TUMAN SVODI -->
        <div id="tumanView" class="report-view">
            <div class="controls">
                <div class="filter-group">
                    <label data-i18n="label_date">Sana</label>
                    <input type="date" id="tumanDate" onchange="loadTumanData()">
                </div>
                <div class="filter-group" id="tumanSelectGroup">
                    <label data-i18n="label_district_sel">Tumanni tanlang</label>
                    <select id="tumanSelect" onchange="loadTumanData()">
                        <option value="" data-i18n="label_boshqa">Tanlang...</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="exportTuman()" data-i18n="btn_excel"><i
                        class="fas fa-file-excel"></i> Excelga saqlash</button>
            </div>
            <div style="overflow-x: auto;">
                <table id="tumanTable">
                    <thead>
                        <tr>
                            <th rowspan="2">Holat</th>
                            <th rowspan="2">Maktab nomi</th>
                            <th rowspan="2">Vaqt</th>
                            <th rowspan="2">Sinflar</th>
                            <th rowspan="2">O'quvchilar</th>
                            <th colspan="5" style="text-align:center; background:#e0f2f1">Sababli kelmaganlar</th>
                            <th colspan="10" style="text-align:center; background:#fff3e0">Sababsiz kelmaganlar</th>
                            <th rowspan="2">Davomat %</th>
                            <th rowspan="2">Manba</th>
                            <th rowspan="2">Mas'ul</th>
                        </tr>
                        <tr style="font-size: 10px;">
                            <!-- Sababli -->
                            <th title="Kasalligi">Kas.</th>
                            <th title="Tadbirlar">Tad.</th>
                            <th title="Oilaviy">Oil.</th>
                            <th title="Ijtimoiy">Ijt.</th>
                            <th title="Boshqa">Bos.</th>
                            <!-- Sababsiz -->
                            <th title="Muntazam">Mun.</th>
                            <th title="Qidiruv">Qid.</th>
                            <th title="Chet el">Ch.el</th>
                            <th title="Bo‚Äòyin tovlagan">Bo‚Äòy.</th>
                            <th title="Ishlab yurgan">Ish</th>
                            <th title="Qarshilik">Qar.</th>
                            <th title="Jazo/Tergov">Jaz.</th>
                            <th title="Nazoratsiz">Naz.</th>
                            <th title="Turmushga chiqqan">Tur.</th>
                            <th title="Boshqa sababsiz">Bos.</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 3. DETAILED ABSENTS -->
        <div id="studentsView" class="report-view">
            <div class="controls">
                <div class="filter-group">
                    <label data-i18n="label_date">Sana</label>
                    <input type="date" id="absentDate" onchange="loadAbsentDetails()">
                </div>
            </div>
            <table id="absentTable">
                <thead>
                    <tr>
                        <th data-i18n="col_class">Sinf</th>
                        <th data-i18n="col_fio">O'quvchi F.I.SH</th>
                        <th data-i18n="col_address">Yashash manzili</th>
                        <th data-i18n="col_parent">Ota-onasi</th>
                        <th data-i18n="col_phone_t">Telefon</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- 4. RECENT ACTIVITY (LIVE) -->
        <div id="recentView" class="report-view">
            <div class="controls">
                <div class="filter-group">
                    <label>Xolati: Jonli (Oxirgi 30 ta kiritilgan ma'lumot)</label>
                    <button class="tab-btn" onclick="loadRecentActivity()"
                        style="padding: 5px 15px; font-size: 12px;">Yangilash</button>
                </div>
            </div>
            <table id="recentTable">
                <thead>
                    <tr>
                        <th data-i18n="col_time">Vaqt (Sana)</th>
                        <th data-i18n="col_district">Hudud</th>
                        <th data-i18n="col_schools">Maktab</th>
                        <th data-i18n="col_percent">Davomat</th>
                        <th data-i18n="col_sababsiz">Sababsiz</th>
                        <th data-i18n="col_source">Manba</th>
                        <th data-i18n="col_responsible">Mas'ul</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        </table>
    </div>

    <!-- 5. MAKTAB KABINETI -->
    <div id="schoolView" class="report-view">
        <h3 style="margin-bottom:20px" id="schoolNameHeader">Mening Maktabim</h3>
        <div id="schoolSummaryCards" class="summary-stats">
            <div class="stat-card">
                <h4>Muddati</h4>
                <div class="value" style="font-size:1.2rem">Bugun kiritilgan</div>
            </div>
        </div>
        <div class="stat-card" style="margin-top:20px">
            <h4><i class="fas fa-history"></i> Oxirgi 30 kunlik davomat tarixi</h4>
            <table id="schoolHistoryTable">
                <thead>
                    <tr>
                        <th data-i18n="label_date">Sana</th>
                        <th data-i18n="col_time">Vaqt</th>
                        <th data-i18n="col_student">O'quvchi</th>
                        <th data-i18n="col_sababsiz">Kelmagan</th>
                        <th data-i18n="col_percent">Davomat (%)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="export-btn" onclick="location.href='davomat.html'"
            style="margin-top:20px; background:var(--primary)">
            <i class="fas fa-plus"></i> Yangi davomat kiritish
        </button>
    </div>

    <!-- 4.1. ANALYSIS (Leadership Charts) -->
    <div id="analysisView" class="report-view">
        <h3 style="margin-bottom:20px"><i class="fas fa-chart-pie"></i> Viloyat davomat tahlili (Kecha va Bugun)</h3>
        <div id="analysisSummary" class="summary-stats">
            <!-- Dynamicly fueled -->
        </div>

        <div class="stat-card" style="margin-bottom: 20px; display:none;">
            <div id="mapContainerAnalysis" class="map-grid"></div>
        </div>
        <div class="ai-insight" id="aiInsights">
            <i class="fas fa-robot"></i>
            <div class="ai-text" id="aiText">Ma'lumotlar tahlil qilinmoqda... Tumanlar bo'yicha hisobotlarni yuklang.
            </div>
        </div>

        <div class="leaderboard-grid">
            <div class="stat-card">
                <h4>üèÜ Eng yaxshi natijalar</h4>
                <div id="topDistricts"></div>
            </div>
            <div class="stat-card">
                <h4>üìâ E'tibor talab hududlar</h4>
                <div id="bottomDistricts"></div>
            </div>
        </div>

        <div class="summary-stats">
            <div class="stat-card" style="grid-column: span 2;">
                <h4>Hududlar kesimida davomat (Solishtirma)</h4>
                <canvas id="districtChart" style="max-height: 350px;"></canvas>
            </div>
            <div class="stat-card">
                <h4>Davomat sabablari (Turlari bo'yicha)</h4>
                <canvas id="reasonsChart" style="max-height: 350px;"></canvas>
            </div>
        </div>
        <div class="stat-card" style="margin-top:20px">
            <h4><i class="fas fa-chart-line"></i> 30 kunlik davomat dinamikasi</h4>
            <canvas id="trendChart" style="max-height: 300px; width:100%"></canvas>
        </div>
        <div id="toastContainer" class="toast-container"></div>
    </div>
    <div id="profileView" class="report-view">
        <h3 style="margin-bottom:20px"><i class="fas fa-user-circle"></i> Mening profilim</h3>
        <div class="stat-card" style="margin-bottom: 30px; border-left: 4px solid var(--primary);">
            <div id="userProfileCard" style="padding: 10px 0;">
                <!-- Will be filled by script.js -->
                <div style="display:flex; align-items:center; gap:20px;">
                    <div
                        style="width:60px; height:60px; background:rgba(99, 102, 241, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:var(--primary)">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h2 id="profile_fish" style="margin:0; font-size:1.4rem;">...</h2>
                        <p id="profile_role" style="margin:5px 0 0; color:#94a3b8; font-size:0.9rem;">...</p>
                    </div>
                </div>
            </div>
        </div>

        <h3 style="margin-bottom:20px"><i class="fas fa-key"></i> Parolni almashtirish</h3>
        <div class="stat-card" style="max-width: 400px;">
            <div style="margin-bottom:15px">
                <label style="display:block; margin-bottom:5px">Yangi parol</label>
                <input type="password" id="newPassword" placeholder="Yangi parol..." style="width:100%">
            </div>
            <button class="export-btn" onclick="changePassword()" style="width:100%; justify-content:center">
                <i class="fas fa-save"></i> Saqlash
            </button>
            <div id="pwMsg" style="margin-top:10px; font-weight:bold"></div>
        </div>
    </div>

    <!-- 6. ADMIN (User Management) -->
    <div id="adminView" class="report-view">
        <h3 style="margin-bottom:20px"><i class="fas fa-users-cog"></i> Foydalanuvchilar boshqaruvi</h3>
        <div class="controls" style="margin-bottom:20px">
            <p>Barcha hududlar uchun joriy parollar ro'yxati</p>
        </div>
        <table id="usersTable">
            <thead>
                <tr>
                    <th>Login</th>
                    <th>Hudud</th>
                    <th>Joriy Parol</th>
                    <th>Harakat</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    </div>

    <script>
        // AUTH CHECK
        const token = localStorage.getItem('dashboard_token');
        const userRole = localStorage.getItem('dashboard_role');
        const userDistrict = localStorage.getItem('dashboard_district');
        const userSchool = localStorage.getItem('dashboard_school');

        if (!token) {
            window.location.href = 'login.html';
        }

        async function apiFetch(url) {
            const res = await fetch(url, {
                headers: { 'Authorization': token }
            });
            if (res.status === 401) logout();
            return res.json();
        }

        // Adjust for Roles
        if (userRole === 'district') {
            document.getElementById('tab_viloyat').innerHTML = '<i class="fas fa-map"></i> Mening Hududim';
            document.getElementById('tumanSelect').innerHTML = `<option value="${userDistrict}">${userDistrict}</option>`;
            document.getElementById('tumanSelect').disabled = true;
        } else if (userRole === 'school') {
            document.getElementById('tab_viloyat').style.display = 'none';
            document.getElementById('tab_tuman').style.display = 'none';
            document.getElementById('tab_students').style.display = 'none';
            document.getElementById('tab_school').style.display = 'flex';
            document.getElementById('schoolNameHeader').textContent = userSchool;
            showTab('school');
            loadSchoolData();
        } else if (userRole === 'superadmin') {
            document.getElementById('tab_admin').style.display = 'flex';
        }

        // Set default dates to Farg'ona time
        const fargonaNow = new Date(new Date().getTime() + (5 * 60 + new Date().getTimezoneOffset()) * 60000);
        const dateStr = fargonaNow.toISOString().split('T')[0];

        document.getElementById('viloyatDate').value = dateStr;
        document.getElementById('tumanDate').value = dateStr;
        document.getElementById('absentDate').value = dateStr;

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.report-view').forEach(v => v.classList.remove('active'));

            if (tab === 'viloyat') {
                document.getElementById('tab_viloyat').classList.add('active');
                document.getElementById('viloyatView').classList.add('active');
                loadViloyatData();
            } else if (tab === 'tuman') {
                document.getElementById('tab_tuman').classList.add('active');
                document.getElementById('tumanView').classList.add('active');
                loadTumanData();
            } else if (tab === 'students') {
                document.getElementById('tab_students').classList.add('active');
                document.getElementById('studentsView').classList.add('active');
                loadAbsentDetails();
            } else if (tab === 'recent') {
                document.getElementById('tab_recent').classList.add('active');
                document.getElementById('recentView').classList.add('active');
                loadRecentActivity();
            } else if (tab === 'analysis') {
                document.getElementById('tab_analysis').classList.add('active');
                document.getElementById('analysisView').classList.add('active');
                loadAnalysisData();
            } else if (tab === 'school') {
                document.getElementById('tab_school').classList.add('active');
                document.getElementById('schoolView').classList.add('active');
                loadSchoolData();
            } else if (tab === 'profile') {
                document.getElementById('tab_profile').classList.add('active');
                document.getElementById('profileView').classList.add('active');
            } else if (tab === 'admin') {
                document.getElementById('tab_admin').classList.add('active');
                document.getElementById('adminView').classList.add('active');
                loadUsers();
            }
        }

        async function loadDistricts() {
            if (userRole === 'district') return;
            const data = await apiFetch('/api/districts');
            const select = document.getElementById('tumanSelect');
            data.forEach(d => {
                if (d === 'Test rejimi') return;
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                select.appendChild(opt);
            });
        }

        function openDistrictStats(districtName) {
            const select = document.getElementById('tumanSelect');
            if (select) {
                select.value = districtName;
                showTab('tuman');
            }
        }

        async function loadViloyatData() {
            const date = document.getElementById('viloyatDate').value;
            const data = await apiFetch(`/api/stats/viloyat?date=${date}`);
            const tbody = document.querySelector('#viloyatTable tbody');
            tbody.innerHTML = '';

            let totalE = 0, totalS = 0, totalSababsiz = 0, totalAbsentSum = 0;

            data.forEach(item => {
                totalE += parseInt(item.entries) || 0;
                totalS += parseInt(item.students) || 0;
                totalSababsiz += parseInt(item.sababsiz) || 0;
                totalAbsentSum += parseInt(item.total_absent) || 0;

                const diff = item.avg_percent - item.yesterday_percent;
                const isLower = diff < 0;
                const districtSafe = item.district.replace(/'/g, "\\'");

                const row = `<tr>
                    <td style="cursor:pointer; color:#fff !important; font-weight:700; background:rgba(255,255,255,0.05); border-radius:8px" onclick="openDistrictStats('${districtSafe}')">
                        <i class="fas fa-chart-bar" style="margin-right:8px; color:#818cf8"></i> ${item.district}
                    </td>
                    <td>${item.entries}</td>
                    <td>${item.students}</td>
                    <td>${item.sababli}</td>
                    <td><span style="color:red">${item.sababsiz}</span></td>
                    <td style="color:#818cf8; font-weight:600">${item.yesterday_percent > 0 ? item.yesterday_percent.toFixed(1) + '%' : '-'}</td>
                    <td>
                        <span class="status-badge ${item.avg_percent >= 95 ? 'status-high' : 'status-low'}" style="${isLower ? 'background: #f43f5e; color: white;' : ''}">
                            ${item.avg_percent.toFixed(1)}%
                            ${item.yesterday_percent > 0 ? (isLower ? '<i class="fas fa-caret-down"></i>' : '<i class="fas fa-caret-up"></i>') : ''}
                        </span>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });

            document.getElementById('v_total_entries').textContent = totalE;
            document.getElementById('v_total_students').textContent = totalS;
            document.getElementById('v_total_sababsiz').textContent = totalSababsiz;

            const viloyatAvg = totalS > 0 ? (((totalS - totalAbsentSum) / totalS) * 100).toFixed(1) : '0';
            document.getElementById('v_avg_percent').textContent = viloyatAvg + '%';

            renderHeatmap(data);
        }

        function renderHeatmap(data) {
            const container = document.getElementById('mapContainer');
            if (!container) return;
            container.innerHTML = '';
            data.forEach(item => {
                const node = document.createElement('div');
                node.className = 'map-node';
                node.title = `${item.district}: ${item.avg_percent.toFixed(1)}%`;
                let color = '#f43f5e';
                if (item.avg_percent >= 95) color = '#10b981';
                else if (item.avg_percent >= 90) color = '#facc15';

                node.style.background = color;
                node.innerHTML = `<span style="font-size:9px; color:#000; font-weight:bold; line-height:1.2; text-align:center; padding: 2px;">${item.district}</span>`;
                node.style.display = 'flex';
                node.style.alignItems = 'center';
                node.style.justifyContent = 'center';
                node.style.textAlign = 'center';
                node.style.padding = '5px';
                node.onclick = () => {
                    document.getElementById('tumanSelect').value = item.district;
                    showTab('tuman');
                    loadTumanData();
                };
                container.appendChild(node);
            });
        }

        async function loadTumanData() {
            const tuman = document.getElementById('tumanSelect').value;
            const date = document.getElementById('tumanDate').value;
            if (!tuman) return;

            const data = await apiFetch(`/api/stats/tuman?tuman=${encodeURIComponent(tuman)}&date=${date}`);
            const tbody = document.querySelector('#tumanTable tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const isSent = item.fio !== 'Kiritilmagan';
                const row = `<tr style="${!isSent ? 'background: rgba(239, 68, 68, 0.05)' : ''}">
                    <td style="text-align:center">
                        ${isSent ? '<i class="fas fa-check-circle" style="color:#10b981; font-size:1.2rem"></i>' : '<i class="fas fa-times-circle" style="color:#ef4444; font-size:1.2rem"></i>'}
                    </td>
                    <td><b>${item.school}</b></td>
                    <td>${item.time}</td>
                    <td>${item.classes_count}</td>
                    <td>${item.total_students}</td>
                    <td style="color:#64748b">${item.sababli_kasal || 0}</td>
                    <td style="color:#64748b">${item.sababli_tadbirlar || 0}</td>
                    <td style="color:#64748b">${item.sababli_oilaviy || 0}</td>
                    <td style="color:#64748b">${item.sababli_ijtimoiy || 0}</td>
                    <td style="color:#64748b">${item.sababli_boshqa || 0}</td>
                    <td style="color:red">${item.sababsiz_muntazam || 0}</td>
                    <td style="color:red">${item.sababsiz_qidiruv || 0}</td>
                    <td style="color:red">${item.sababsiz_chetel || 0}</td>
                    <td style="color:red">${item.sababsiz_boyin || 0}</td>
                    <td style="color:red">${item.sababsiz_ishlab || 0}</td>
                    <td style="color:red">${item.sababsiz_qarshilik || 0}</td>
                    <td style="color:red">${item.sababsiz_jazo || 0}</td>
                    <td style="color:red">${item.sababsiz_nazoratsiz || 0}</td>
                    <td style="color:red">${item.sababsiz_turmush || 0}</td>
                    <td style="color:red">${item.sababsiz_boshqa || 0}</td>
                    <td><span class="status-badge ${item.percent >= 95 ? 'status-high' : 'status-low'}" style="font-size:10px">${(item.percent || 0).toFixed(1)}%</span></td>
                    <td style="text-align:center">
                        ${isSent ? (item.source === 'web' ? '<i class="fas fa-globe" title="Web"></i>' : '<i class="fab fa-telegram" title="Bot"></i>') : '-'}
                    </td>
                    <td style="font-size:11px">${item.fio}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function loadRecentActivity() {
            const data = await apiFetch('/api/stats/recent');
            const tbody = document.querySelector('#recentTable tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const sourceIcon = item.source === 'web' ? '<i class="fas fa-globe" style="color:#3b82f6" title="Web Sahifa"></i> web' : '<i class="fab fa-telegram" style="color:#0088cc" title="Telegram Bot"></i> bot';

                // Format date for display: DD.MM.YYYY
                const d = item.date.split('-');
                const displayDate = d.length === 3 ? `${d[2]}.${d[1]}.${d[0]}` : item.date;

                const row = `<tr>
                    <td style="font-weight: 500;">
                        <span style="color: #818cf8;">${item.time}</span> 
                        <span style="color: #94a3b8; font-size: 0.8em; margin-left: 5px;">${displayDate}</span>
                    </td>
                    <td>${item.district}</td>
                    <td>${item.school}</td>
                    <td style="text-align:center"><span class="status-badge ${item.percent >= 95 ? 'status-high' : 'status-low'}" style="font-size:11px">${(item.percent || 0).toFixed(1)}%</span></td>
                    <td style="text-align:center"><span style="color:${item.sababsiz_jami > 0 ? '#f43f5e' : '#10b981'}; font-weight:bold">${item.sababsiz_jami}</span></td>
                    <td style="text-align:center">${sourceIcon}</td>
                    <td style="font-size: 11px;">${item.fio}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function loadAbsentDetails() {
            const date = document.getElementById('absentDate').value;
            const data = await apiFetch(`/api/stats/absentees?date=${date}`);
            const tbody = document.querySelector('#absentTable tbody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = `<tr>
                    <td>${item.district}</td>
                    <td>${item.school}</td>
                    <td>${item.class}</td>
                    <td><b>${item.name}</b></td>
                    <td>${item.address}</td>
                    <td>${item.parent_name}</td>
                    <td>${item.parent_phone}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        let districtChart, reasonsChart, trendChart;
        async function loadAnalysisData() {
            const today = new Date().toISOString().split('T')[0];
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterday = yesterdayDate.toISOString().split('T')[0];

            let [todayData, yesterdayData] = await Promise.all([
                apiFetch(`/api/stats/viloyat?date=${today}`),
                apiFetch(`/api/stats/viloyat?date=${yesterday}`)
            ]);

            if (!Array.isArray(todayData)) todayData = [];
            if (!Array.isArray(yesterdayData)) yesterdayData = [];

            // MAP RENDERING
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                mapContainer.innerHTML = '';
                const districtGrid = [
                    { n: "Beshariq", x: 1, y: 3 }, { n: "Furqat", x: 2, y: 3 }, { n: "O'zbekiston", x: 2, y: 4 },
                    { n: "Dang'ara", x: 3, y: 2 }, { n: "Qo'qon shahri", x: 3, y: 3 }, { n: "Uchko'prik", x: 4, y: 3 },
                    { n: "Buvayda", x: 4, y: 2 }, { n: "Bag'dod", x: 5, y: 3 }, { n: "Yozyovon", x: 6, y: 1 },
                    { n: "Oltiariq", x: 5, y: 4 }, { n: "Rishton", x: 4, y: 4 }, { n: "Qo'shtepa", x: 6, y: 3 },
                    { n: "Toshloq", x: 7, y: 2 }, { n: "Marg'ilon shahri", x: 7, y: 3 }, { n: "Quva", x: 8, y: 3 },
                    { n: "Farg'ona shahri", x: 7, y: 4 }, { n: "Farg'ona tumani", x: 8, y: 4 }, { n: "Quvasoy shahri", x: 8, y: 5 },
                    { n: "So'x", x: 4, y: 5 }
                ];

                districtGrid.forEach(pos => {
                    const dData = todayData.find(d => d.district.toLowerCase().includes(pos.n.toLowerCase().replace(' shahri', '').replace(' tumani', ''))) || { avg_percent: 0 };
                    const node = document.createElement('div');
                    node.className = 'map-node';
                    node.style.gridColumn = pos.x;
                    node.style.gridRow = pos.y;

                    const p = dData.avg_percent || 0;
                    let color = '#f43f5e';
                    if (p >= 95) color = '#10b981';
                    else if (p >= 90) color = '#facc15';

                    node.style.borderTop = `4px solid ${color}`;
                    node.innerHTML = `<div class="name" style="font-size:9px; font-weight:bold; color:white;">${pos.n}</div><div class="val">${p > 0 ? p.toFixed(1) + '%' : '-'}</div>`;
                    node.onclick = () => {
                        document.getElementById('tumanSelect').value = dData.district || pos.n;
                        showTab('tuman');
                        loadTumanData();
                    };
                    mapContainer.appendChild(node);
                });
            }

            const labels = todayData.map(d => d.district);
            const percents = todayData.map(d => d.avg_percent);

            const todayAvg = todayData.length > 0 ? todayData.reduce((a, b) => a + b.avg_percent, 0) / todayData.length : 0;
            const yesterdayAvg = yesterdayData.length > 0 ? yesterdayData.reduce((a, b) => a + b.avg_percent, 0) / yesterdayData.length : 0;
            const diff = todayAvg - yesterdayAvg;

            const comparisonHtml = `
                <div style="font-size: 0.9rem; margin-top: 5px; color: ${diff >= 0 ? '#10b981' : '#f43f5e'}">
                    <i class="fas fa-caret-${diff >= 0 ? 'up' : 'down'}"></i> 
                    ${Math.abs(diff).toFixed(1)}% <sup>kechagiga nisbatan</sup>
                </div>
            `;

            const analysisSummary = document.getElementById('analysisSummary');
            if (analysisSummary) {
                analysisSummary.innerHTML = `
                    <div class="stat-card">
                        <h4>Viloyat o'rtacha davomati</h4>
                        <div class="value">${todayAvg.toFixed(1)}%</div>
                        ${comparisonHtml}
                    </div>
                `;
            }

            if (todayData.length > 0) {
                // Leaderboard logic
                const sorted = [...todayData].sort((a, b) => b.avg_percent - a.avg_percent);
                const top3 = sorted.slice(0, 3);
                const bottom3 = sorted.filter(d => d.entries > 0).slice(-3).reverse();

                document.getElementById('topDistricts').innerHTML = top3.map(d => `
                    <div class="l-item top">
                        <span><b>${d.district}</b></span>
                        <span class="status-badge status-high">${d.avg_percent.toFixed(1)}%</span>
                    </div>
                `).join('');

                document.getElementById('bottomDistricts').innerHTML = bottom3.map(d => `
                    <div class="l-item bottom">
                        <span><b>${d.district}</b></span>
                        <span class="status-badge status-low">${d.avg_percent.toFixed(1)}%</span>
                    </div>
                `).join('');

                // AI Insights text
                const best = top3[0];
                const worst = bottom3[0];
                let insight = `Bugungi tahlil: <b>${best.district}</b> eng yuqori natijani ko'rsatmoqda (${best.avg_percent.toFixed(1)}%). `;
                if (worst) insight += `<b>${worst.district}</b> hududida davomat nisbatan past, nazoratni kuchaytirish tavsiya etiladi. `;
                const totalS = todayData.reduce((a, b) => a + (parseInt(b.students) || 0), 0);
                const totalSS = todayData.reduce((a, b) => a + (parseInt(b.sababsiz) || 0), 0);
                insight += `<br>Viloyat bo'yicha jami sababsiz kelmaganlar soni: <b>${totalSS}</b> nafar.`;
                document.getElementById('aiText').innerHTML = insight;
            }

            const ctx1 = document.getElementById('districtChart').getContext('2d');
            if (districtChart) districtChart.destroy();
            districtChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bugun',
                        data: percents,
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderColor: '#6366f1',
                        borderWidth: 1,
                        borderRadius: 8
                    }, {
                        label: 'Kecha',
                        data: yesterdayData.map(d => d.avg_percent),
                        backgroundColor: 'rgba(255, 255, 255, 0.1)',
                        borderColor: 'rgba(255,255,255,0.3)',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, labels: { color: '#fff' } } },
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { grid: { display: false }, ticks: { color: '#fff' } }
                    }
                }
            });

            const totalSababli = todayData.reduce((a, b) => a + (parseInt(b.sababli) || 0), 0);
            const totalSababsiz = todayData.reduce((a, b) => a + (parseInt(b.sababsiz) || 0), 0);

            const ctx2 = document.getElementById('reasonsChart').getContext('2d');
            if (reasonsChart) reasonsChart.destroy();
            reasonsChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Sababli', 'Sababsiz'],
                    datasets: [{
                        data: [totalSababli, totalSababsiz],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } }
                }
            });

            // TREND CHART
            const trendData = await apiFetch('/api/stats/trends');
            const ctx3 = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            trendChart = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.date),
                    datasets: [{
                        label: '30 kunlik trend',
                        data: trendData.map(d => d.avg_percent),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        y: { min: 70, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                        x: { ticks: { color: '#fff' } }
                    }
                }
            });
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = 'toast';
            const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'exclamation-circle' : 'info-circle');
            const color = type === 'success' ? '#10b981' : (type === 'error' ? '#ef4444' : '#6366f1');
            toast.style.borderLeftColor = color;
            toast.innerHTML = `<i class="fas fa-${icon}" style="color:${color}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 4000);
        }

        async function loadSchoolData() {
            const history = await apiFetch('/api/stats/school');
            const tbody = document.querySelector('#schoolHistoryTable tbody');
            tbody.innerHTML = '';

            if (history.length > 0) {
                const latest = history[0];
                document.getElementById('schoolSummaryCards').innerHTML = `
                    <div class="stat-card">
                        <h4>Oxirgi holat (${latest.date})</h4>
                        <div class="value">${latest.percent}%</div>
                    </div>
                    <div class="stat-card">
                        <h4>Jami o'quvchi</h4>
                        <div class="value">${latest.total_students}</div>
                    </div>
                `;

                history.forEach(item => {
                    const rowClass = item.percent >= 95 ? 'status-good' : (item.percent >= 90 ? 'status-warn' : 'status-danger');
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.date}</td>
                            <td>${item.time}</td>
                            <td>${item.total_students}</td>
                            <td>${item.total_absent}</td>
                            <td><span class="status-badge ${rowClass}">${item.percent}%</span></td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Hali ma\'lumot kiritilmagan</td></tr>';
            }
        }

        async function exportViloyatExcel() {
            const date = document.getElementById('viloyatDate').value;
            const link = document.createElement('a');
            link.href = `/api/export/viloyat?date=${date}&token=${token}`;
            link.download = `VILOYAT_HISOBOT_${date}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportTumanExcel() {
            const tuman = document.getElementById('tumanSelect').value;
            const date = document.getElementById('tumanDate').value;
            if (!tuman) return alert("Avval hududni tanlang!");
            const link = document.createElement('a');
            link.href = `/api/export/tuman?tuman=${encodeURIComponent(tuman)}&date=${date}&token=${token}`;
            link.download = `TUMAN_HISOBOT_${tuman}_${date}.xlsx`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function changePassword() {
            const newPw = document.getElementById('newPassword').value;
            const msg = document.getElementById('pwMsg');
            if (!newPw) return;

            try {
                const res = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ password: newPw })
                });
                const data = await res.json();
                if (res.ok) {
                    msg.style.color = '#10b981';
                    msg.textContent = "Parol muvaffaqiyatli almashtirildi!";
                    document.getElementById('newPassword').value = '';
                } else {
                    msg.style.color = '#ef4444';
                    msg.textContent = data.error || "Xatolik!";
                }
            } catch (e) { msg.textContent = "Ulanishda xatolik!"; }
        }

        async function loadUsers() {
            const data = await apiFetch('/api/admin/users');
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            Object.entries(data).forEach(([login, user]) => {
                const row = `<tr>
                    <td>${login}</td>
                    <td>${user.district || 'SUPERADMIN'}</td>
                    <td><b>${user.password}</b></td>
                    <td>
                        <button class="export-btn" onclick="resetUserPassword('${login}')" style="padding: 5px 10px; font-size:12px">
                            Resurs
                        </button>
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function resetUserPassword(login) {
            const newPw = prompt(`${login} uchun yangi parolni kiriting (bo'sh qolsa 123 bo'ladi):`, '123');
            if (newPw === null) return;

            try {
                const res = await fetch('/api/admin/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify({ targetLogin: login, newPassword: newPw || '123' })
                });
                if (res.ok) {
                    alert("Parol o'zgartirildi!");
                    loadUsers();
                }
            } catch (e) { alert("Xatolik!"); }
        }

        function filterTumanTable() {
            const input = document.getElementById("schoolSearch");
            const filter = input.value.toUpperCase();
            const table = document.getElementById("tumanTable");
            const tr = table.getElementsByTagName("tr");
            for (let i = 2; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName("td")[1];
                if (td) {
                    const txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        }

        loadDistricts();
        loadViloyatData();
    </script>
    <!-- Footer -->
    <section class="app-download-section">
        <div class="app-download-content">
            <h2 data-i18n="app_download_title">Mobil ilovani yuklab oling</h2>
            <p data-i18n="app_download_subtitle">Davomat tizimidan yanada qulay foydalanish uchun rasmiy mobil ilovani
                o'rnatib oling.</p>
            <div class="app-store-btns">
                <a href="#" class="store-btn install-trigger" onclick="installApp()">
                    <i class="fab fa-google-play"></i>
                    <div>
                        <small>Get it on</small>
                        <strong data-i18n="btn_google_play">Google Play</strong>
                    </div>
                </a>
                <a href="#" class="store-btn install-trigger" onclick="installApp()">
                    <i class="fab fa-apple"></i>
                    <div>
                        <small>Download on the</small>
                        <strong data-i18n="btn_app_store">App Store</strong>
                    </div>
                </a>
            </div>
        </div>
    </section>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <img src="logo.png" style="width: 40px; height: auto;">
                    <h4 style="margin:0;">Ferghanaregdavomat</h4>
                </div>
                <p data-i18n="footer_desc">Farg'ona viloyati Maktabgacha va maktab ta'limi boshqarmasi tizimidagi
                    o‚Äòquvchilar davomati bo‚Äòyicha maxsus portal.</p>
            </div>
            <div class="footer-section">
                <h4 data-i18n="footer_contact">Bog'lanish</h4>
                <p><i class="fas fa-map-marker-alt"></i> Farg‚Äòona v., Dodxox ko‚Äòchasi 2 uy</p>
                <p><i class="fas fa-phone"></i> +998 (88) 595-23-23</p>
                <p><i class="fas fa-envelope"></i> imronbekr@gmail.com</p>
            </div>
            <div class="footer-section">
                <h4 data-i18n="footer_links">Tezkor havolalar</h4>
                <ul style="padding:0; list-style:none;">
                    <li><a href="/" data-i18n="nav_home">Bosh sahifa</a></li>
                    <li><a href="/davomat.html" data-i18n="nav_form">Davomat kiritish</a></li>
                    <li><a href="/dashboard.html" data-i18n="nav_dashboard">Dashboard</a></li>
                    <li><a href="/about.html" data-i18n="nav_about">Biz haqimizda</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Ferghanaregdavomat. All rights reserved. <span style="opacity:0.5">v2.1-FIXED</span></p>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js?v=100"></script>
</body>

</html>